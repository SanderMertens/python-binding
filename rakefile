require 'rake/clean'

Version = "0.1"
ENV['PYTHON_BINDING_VERSION'] = Version
Debug = true

cflags = %w(-std=c99 -Wstrict-prototypes -pedantic)

if Debug then
  cflags << "-O0"
end

ENV["CFLAGS"] = cflags.join(" ")

SupportedPythonVersions = %w(3.4 3.5)

def check_python_version_supported?
  python_version = `python --version`
  is_supported = SupportedPythonVersions.map do |v|
    "Python #{v}."
  end.any? do |v|
    python_version.start_with? v
  end
  unless is_supported
    python_version = "< 3.3" if python_version.empty?
    raise "Unsupported Python version: #{python_version}"
  end
end

task :build do
  check_python_version_supported?
  sh "python setup.py build"
  sh "python setup.py sdist"
  begin
    sh "pip uninstall --yes cortopy"
  rescue
  end
  sh "pip install dist/cortopy-#{Version}.tar.gz"
end

task :test do
  sh "py.test -vvv test/"
end

task :env do
  sh "rm -rf env"
  sh "python3 -m venv env"
  sh "./env/bin/pip install --upgrade pip"
  sh "./env/bin/pip install -r requirements-dev.txt"
end

task :default do
  Rake::Task["build"].invoke
  Rake::Task["test"].invoke
end
